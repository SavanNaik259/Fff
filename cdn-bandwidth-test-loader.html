
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDN Bandwidth Test - Product Loader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .secondary-btn { background: #6c757d; }
        .secondary-btn:hover { background: #545b62; }
        .danger-btn { background: #dc3545; }
        .danger-btn:hover { background: #c82333; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
        }
        .product-name {
            font-weight: bold;
            margin: 10px 0 5px 0;
            font-size: 16px;
        }
        .product-price {
            color: #007bff;
            font-size: 18px;
            font-weight: bold;
        }
        .product-description {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .message {
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .bandwidth-info {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        .bandwidth-info h3 {
            margin-top: 0;
            color: #007bff;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .test-instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .test-instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .test-instructions li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• CDN Bandwidth Test - Product Loader</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è DEPLOYMENT REQUIRED:</strong> This test only works on your deployed Netlify site. Local testing will not show CDN behavior.
        </div>

        <div class="bandwidth-info">
            <h3>üìä How CDN Testing Works:</h3>
            <ol>
                <li><strong>Step 1:</strong> Netlify function provides Firebase Storage download URL (no bandwidth)</li>
                <li><strong>Step 2:</strong> Client fetches directly from Firebase Storage CDN</li>
                <li><strong>First visitor per region:</strong> Downloads from Firebase (bandwidth used)</li>
                <li><strong>Subsequent visitors:</strong> CDN cache hit (no bandwidth used)</li>
                <li><strong>Monitor:</strong> Firebase Console ‚Üí Storage ‚Üí Usage for bandwidth tracking</li>
            </ol>
        </div>

        <div class="test-instructions">
            <h3>üß™ CDN Testing Steps:</h3>
            <ol>
                <li><strong>Upload products</strong> using the uploader tool</li>
                <li><strong>Load products</strong> for the first time (triggers Firebase download)</li>
                <li><strong>Wait 2-3 minutes</strong> for CDN to cache files</li>
                <li><strong>Load again</strong> from different browser/device (should use CDN)</li>
                <li><strong>Monitor Firebase bandwidth</strong> - should only increase on first load</li>
            </ol>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="requestTime">-</div>
                <div class="stat-label">Request Time (ms)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="productCount">-</div>
                <div class="stat-label">Products Loaded</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cacheStatus">-</div>
                <div class="stat-label">Response Type</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="dataSize">-</div>
                <div class="stat-label">Data Size (KB)</div>
            </div>
        </div>

        <div class="test-controls">
            <button onclick="loadProducts('bandwidth-test-1')">üîÑ Load Test Category 1</button>
            <button onclick="loadProducts('bandwidth-test-2')">üîÑ Load Test Category 2</button>
            <button onclick="loadProducts('bandwidth-test-3')">üîÑ Load Test Category 3</button>
            <button class="secondary-btn" onclick="loadAllProducts()">üì¶ Load All Categories</button>
            <button class="secondary-btn" onclick="forceReload()">üö´ Force Reload (No Cache)</button>
            <button class="secondary-btn" onclick="window.open('cdn-bandwidth-test-uploader.html', '_blank')">‚ûï Add Test Product</button>
            <button class="danger-btn" onclick="clearDisplay()">üóëÔ∏è Clear Display</button>
        </div>

        <div id="messages"></div>
        <div id="products" class="product-grid"></div>
    </div>

    <!-- Direct Firebase Storage CDN access - no client SDK needed -->

    <script>
        // Direct Firebase Storage CDN access for true bandwidth testing
        console.log('‚úÖ CDN Bandwidth Test Loader ready - direct Firebase Storage CDN access');
        showMessage('Ready for CDN testing with direct Firebase Storage access!', 'success');

        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            messagesDiv.innerHTML = `<div class="message ${type}">[${timestamp}] ${message}</div>`;
            
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 8000);
        }

        function updateStats(requestTime, productCount, cacheStatus, dataSize) {
            document.getElementById('requestTime').textContent = Math.round(requestTime);
            document.getElementById('productCount').textContent = productCount;
            document.getElementById('cacheStatus').textContent = cacheStatus;
            document.getElementById('dataSize').textContent = Math.round(dataSize / 1024);
        }

        async function loadProducts(category, cacheMode = 'default') {
            try {
                showMessage(`üîÑ Loading ${category} products...`, 'info');
                
                const startTime = performance.now();
                
                // Step 1: Get download URL from function (fast, no bandwidth usage)
                // Detect environment and use appropriate endpoint
                const isLocalDevelopment = window.location.hostname === 'localhost' || window.location.hostname.includes('replit');
                const functionUrl = isLocalDevelopment 
                    ? `/load-bandwidth-test-products?category=${category}`  // Local server endpoint
                    : `/.netlify/functions/load-bandwidth-test-products?category=${category}`;  // Netlify function
                
                console.log(`üîó Getting CDN URL from ${isLocalDevelopment ? 'local server' : 'Netlify function'}...`);
                const urlResponse = await fetch(functionUrl, { method: 'GET' });
                
                if (!urlResponse.ok) {
                    throw new Error(`HTTP ${urlResponse.status}: ${urlResponse.statusText}`);
                }
                
                const urlData = await urlResponse.json();
                
                // Check if the response contains an error
                if (!urlData.success) {
                    showMessage(`${urlData.error || urlData.message}`, 'error');
                    document.getElementById('products').innerHTML = `
                        <div class="empty-state">
                            <h3>Error Loading Products</h3>
                            <p>${urlData.error || urlData.message}</p>
                            <p>Try adding products first using the uploader.</p>
                        </div>
                    `;
                    updateStats(0, 0, 'Error', 0);
                    return;
                }
                
                // Check if we have a download URL
                if (!urlData.downloadUrl) {
                    showMessage(`No products found in ${category}. Add some using the uploader.`, 'info');
                    document.getElementById('products').innerHTML = `
                        <div class="empty-state">
                            <h3>No Products Yet</h3>
                            <p>Click "Add Test Product" to create products for CDN testing.</p>
                        </div>
                    `;
                    updateStats(0, 0, 'No Data', 0);
                    return;
                }
                
                // Step 2: Fetch actual data directly from Firebase Storage CDN
                console.log(`üî• Fetching directly from Firebase Storage CDN with cache mode: ${cacheMode}`);
                const cdnStartTime = performance.now();
                
                const fetchOptions = {
                    cache: cacheMode,
                    method: 'GET'
                };
                
                const response = await fetch(urlData.downloadUrl, fetchOptions);
                
                const endTime = performance.now();
                const requestTime = endTime - cdnStartTime;
                
                if (!response.ok) {
                    throw new Error(`CDN fetch failed: HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                const dataSize = new Blob([responseText]).size;
                const products = JSON.parse(responseText);
                
                // Determine cache status based on response time and headers
                let cacheStatus = 'Unknown';
                if (requestTime < 100) {
                    cacheStatus = 'CDN Cache Hit';
                } else if (requestTime < 300) {
                    cacheStatus = 'Medium (Regional)';
                } else {
                    cacheStatus = 'Origin Download';
                }
                
                // Check response headers for cache indicators
                const cacheControl = response.headers.get('cache-control');
                const etag = response.headers.get('etag');
                const xCacheStatus = response.headers.get('x-cache');
                
                console.log('üî• Firebase Storage CDN Response:', {
                    requestTime: Math.round(requestTime),
                    dataSize: dataSize,
                    cacheControl: cacheControl,
                    etag: etag,
                    xCacheStatus: xCacheStatus,
                    status: response.status,
                    productCount: products.length,
                    cacheMode: cacheMode,
                    message: requestTime < 100 ? 'CDN cache hit - no Firebase bandwidth used!' : 'Origin download - Firebase bandwidth used'
                });
                
                if (!Array.isArray(products) || products.length === 0) {
                    showMessage(`No products found in ${category}. Add some using the uploader.`, 'info');
                    document.getElementById('products').innerHTML = `
                        <div class="empty-state">
                            <h3>No Products Yet</h3>
                            <p>Click "Add Test Product" to create products for CDN testing.</p>
                        </div>
                    `;
                    updateStats(requestTime, 0, cacheStatus, dataSize);
                    return;
                }
                
                displayProducts(products, category);
                updateStats(requestTime, products.length, cacheStatus, dataSize);
                
                // Enhanced message based on CDN performance
                let performanceMessage = '';
                if (requestTime < 100) {
                    performanceMessage = `‚ö° CDN Cache Hit! Loaded ${products.length} products from ${category} in ${Math.round(requestTime)}ms. No Firebase bandwidth used!`;
                } else if (requestTime < 300) {
                    performanceMessage = `üåê Regional CDN: Loaded ${products.length} products from ${category} in ${Math.round(requestTime)}ms. Check Firebase Console for bandwidth usage.`;
                } else {
                    performanceMessage = `üî• Origin Download: Loaded ${products.length} products from ${category} in ${Math.round(requestTime)}ms. This request used Firebase bandwidth.`;
                }
                
                showMessage(performanceMessage, 'success');
                
            } catch (error) {
                console.error('‚ùå Load error:', error);
                showMessage(`Error loading ${category}: ${error.message}`, 'error');
                document.getElementById('products').innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Products</h3>
                        <p>${error.message}</p>
                        <p>Try adding products first using the uploader.</p>
                    </div>
                `;
                updateStats(0, 0, 'Error', 0);
            }
        }

        async function loadAllProducts() {
            const categories = ['bandwidth-test-1', 'bandwidth-test-2', 'bandwidth-test-3'];
            let allProducts = [];
            let totalTime = 0;
            let totalSize = 0;
            
            showMessage('üì¶ Loading all test categories...', 'info');
            
            for (const category of categories) {
                try {
                    // Step 1: Get download URL from function (environment-aware)
                    const isLocalDevelopment = window.location.hostname === 'localhost' || window.location.hostname.includes('replit');
                    const functionUrl = isLocalDevelopment 
                        ? `/load-bandwidth-test-products?category=${category}`
                        : `/.netlify/functions/load-bandwidth-test-products?category=${category}`;
                    const urlResponse = await fetch(functionUrl);
                    
                    if (urlResponse.ok) {
                        const urlData = await urlResponse.json();
                        
                        if (urlData.success && urlData.downloadUrl) {
                            // Step 2: Fetch actual data directly from Firebase Storage CDN
                            const startTime = performance.now();
                            const cdnResponse = await fetch(urlData.downloadUrl);
                            const endTime = performance.now();
                            
                            totalTime += (endTime - startTime);
                            
                            if (cdnResponse.ok) {
                                const responseText = await cdnResponse.text();
                                totalSize += new Blob([responseText]).size;
                                const products = JSON.parse(responseText);
                                
                                if (Array.isArray(products)) {
                                    allProducts = allProducts.concat(products.map(p => ({...p, category})));
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.log(`‚ÑπÔ∏è No products in ${category}:`, error.message);
                }
            }
            
            if (allProducts.length > 0) {
                displayProducts(allProducts, 'All Categories');
                updateStats(totalTime, allProducts.length, 'Combined', totalSize);
                showMessage(`üì¶ Loaded ${allProducts.length} products from all categories in ${Math.round(totalTime)}ms`, 'success');
            } else {
                showMessage('No products found in any category. Add some using the uploader.', 'info');
                updateStats(totalTime, 0, 'No Data', totalSize);
            }
        }

        function forceReload() {
            // Clear browser cache and reload
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            showMessage('üö´ Forcing reload without cache...', 'info');
            
            // Load with no-cache to bypass CDN
            loadProducts('bandwidth-test-1', 'no-cache');
        }

        function displayProducts(products, categoryName) {
            const productsDiv = document.getElementById('products');
            
            if (!Array.isArray(products) || products.length === 0) {
                productsDiv.innerHTML = `
                    <div class="empty-state">
                        <h3>No Products Found</h3>
                        <p>Add some products using the uploader to test CDN behavior.</p>
                    </div>
                `;
                return;
            }
            
            const productCards = products.map(product => `
                <div class="product-card">
                    <img src="${product.image}" alt="${product.name}" class="product-image" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+SW1hZ2UgTm90IEZvdW5kPC90ZXh0Pgo8L3N2Zz4K'">
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">‚Çπ${product.price.toLocaleString()}</div>
                    <div class="product-description">${product.description}</div>
                    ${product.category ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">Category: ${product.category}</div>` : ''}
                </div>
            `).join('');

            productsDiv.innerHTML = productCards;
        }

        function clearDisplay() {
            document.getElementById('products').innerHTML = '';
            updateStats(0, 0, '-', 0);
            showMessage('üóëÔ∏è Display cleared.', 'info');
        }

        // Global error handling
        window.addEventListener('error', (event) => {
            console.error('üí• Global error:', event.error);
            showMessage(`Unexpected error: ${event.error.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('üí• Promise rejection:', event.reason);
            showMessage(`Promise error: ${event.reason.message || event.reason}`, 'error');
            event.preventDefault();
        });

        // Show deployment warning if on localhost
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            setTimeout(() => {
                showMessage('‚ö†Ô∏è You are testing locally. CDN behavior will only work on your deployed Netlify site!', 'error');
            }, 2000);
        } else {
            setTimeout(() => {
                showMessage('‚úÖ Running on deployed site - CDN testing will work correctly!', 'success');
            }, 1000);
        }
    </script>
</body>
</html>
